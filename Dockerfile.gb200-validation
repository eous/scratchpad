# Dockerfile for GB200 SM100 Reference Generation
# Self-contained validation environment using official repos
#
# Build (normal):
#   docker build -f Dockerfile.gb200-validation -t gb200-validation .
#
# Build with cache-busting (force fresh script download):
#   docker build --build-arg SCRIPT_VERSION=v6 -f Dockerfile.gb200-validation -t gb200-validation .
#
# Run:
#   docker run --gpus all -v $(pwd)/output:/output gb200-validation
#
# Quick test (30 seconds):
#   docker run --gpus all -v $(pwd)/output:/output gb200-validation \
#     python3 generate_sm100_reference.py --output /output/sm100_reference.pkl --quick

FROM nvidia/cuda:12.9.0-devel-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install Python and build tools (use default Python from base image)
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-dev \
    python3-pip \
    git \
    ninja-build \
    wget \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Set python3 as default python
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3 1

# Install PyTorch 2.9 with CUDA 12.9 support (matches vLLM container)
RUN pip3 install --no-cache-dir \
    torch==2.9.0 \
    numpy \
    packaging \
    ninja \
    --extra-index-url https://download.pytorch.org/whl/cu129

# CUDA 12.9 environment for SM100/SM120 compatibility
ENV CUDA_HOME=/usr/local/cuda-12.9
ENV PATH=/usr/local/cuda-12.9/bin:$PATH
ENV LD_LIBRARY_PATH=/usr/local/cuda-12.9/lib64:$LD_LIBRARY_PATH
ENV MAX_JOBS=128
ENV CMAKE_BUILD_PARALLEL_LEVEL=128

WORKDIR /workspace

# Cache-busting ARG for script download layer
ARG SCRIPT_VERSION=v9_sync
ENV SCRIPT_VERSION=${SCRIPT_VERSION}

# Clone and build FlashMLA from sm100-validation branch
RUN git clone --recursive -b sm100-validation https://github.com/eous/FlashMLA.git && \
    cd FlashMLA && \
    pip3 install --no-build-isolation -e . && \
    echo "FlashMLA build complete"

# Clone and build DeepGEMM from sm100-validation branch
RUN git clone --recursive -b sm100-validation https://github.com/eous/DeepGEMM.git && \
    cd DeepGEMM && \
    DG_USE_LOCAL_VERSION=1 DG_FORCE_BUILD=1 pip3 install --no-build-isolation . && \
    echo "DeepGEMM build complete"

# Download validation script from scratchpad
# Cache busts when SCRIPT_VERSION ARG changes
# Adds timestamp to URL to bypass GitHub CDN cache
RUN echo "Downloading script version: ${SCRIPT_VERSION}" && \
    wget "https://raw.githubusercontent.com/eous/scratchpad/main/generate_sm100_reference.py?cache_bust=${SCRIPT_VERSION}_$(date +%s)" -O /workspace/generate_sm100_reference.py && \
    chmod +x /workspace/generate_sm100_reference.py && \
    echo "Script SHA256: $(sha256sum /workspace/generate_sm100_reference.py | cut -d' ' -f1)"

# Create output directory
RUN mkdir -p /output

WORKDIR /workspace

# Run validation and package results
CMD python3 generate_sm100_reference.py --output /output/sm100_reference.pkl && \
    echo "" && \
    echo "========================================" && \
    echo "Creating archive and checksums..." && \
    echo "========================================" && \
    cd /output && \
    tar -czf sm100_validation_results.tar.gz sm100_reference.pkl sm100_reference.json && \
    sha256sum sm100_reference.pkl sm100_reference.json sm100_validation_results.tar.gz > checksums.txt && \
    echo "" && \
    echo "========================================" && \
    echo "âœ… GB200 Validation Complete!" && \
    echo "========================================" && \
    echo "" && \
    echo "Output files:" && \
    ls -lh /output/ && \
    echo "" && \
    echo "SHA256 Checksums:" && \
    cat /output/checksums.txt && \
    echo "" && \
    echo "Next steps:" && \
    echo "1. Transfer sm100_validation_results.tar.gz to SM120 machine" && \
    echo "2. Transfer checksums.txt for verification" && \
    echo "3. Run compare_sm100_sm120.py on SM120"
