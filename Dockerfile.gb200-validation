# Dockerfile for GB200 SM100 Reference Generation
# Self-contained validation environment using official repos
#
# Build:
#   docker build -f Dockerfile.gb200-validation -t gb200-validation .
#
# Run:
#   docker run --gpus all -v $(pwd)/output:/output gb200-validation
#
# Quick test (30 seconds):
#   docker run --gpus all -v $(pwd)/output:/output gb200-validation \
#     python3 generate_sm100_reference.py --output /output/sm100_reference.pkl --quick

FROM nvidia/cuda:12.6.0-devel-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install Python 3.12 and build tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.12 \
    python3.12-dev \
    python3-pip \
    git \
    ninja-build \
    wget \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Set python3.12 as default
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 && \
    update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1

# Install PyTorch (CUDA 12.x compatible)
RUN pip3 install --no-cache-dir \
    torch==2.5.1 \
    numpy \
    packaging \
    ninja

# CUDA environment for SM100
ENV CUDA_HOME=/usr/local/cuda-12.6
ENV PATH=/usr/local/cuda-12.6/bin:$PATH
ENV LD_LIBRARY_PATH=/usr/local/cuda-12.6/lib64:$LD_LIBRARY_PATH
ENV MAX_JOBS=128
ENV CMAKE_BUILD_PARALLEL_LEVEL=128

WORKDIR /workspace

# Clone and build FlashMLA from official fork (with cutlass submodule)
RUN git clone --recursive https://github.com/eous/FlashMLA.git && \
    cd FlashMLA && \
    pip3 install --no-build-isolation -e . && \
    echo "FlashMLA build complete"

# Clone and build DeepGEMM from official fork (with cutlass and fmt submodules)
RUN git clone --recursive https://github.com/eous/DeepGEMM.git && \
    cd DeepGEMM && \
    DG_USE_LOCAL_VERSION=1 DG_FORCE_BUILD=1 pip3 install --no-build-isolation . && \
    echo "DeepGEMM build complete"

# Download validation script from scratchpad
RUN wget https://raw.githubusercontent.com/eous/scratchpad/main/generate_sm100_reference.py -O /workspace/generate_sm100_reference.py && \
    chmod +x /workspace/generate_sm100_reference.py

# Create output directory
RUN mkdir -p /output

WORKDIR /workspace

# Run validation and package results
CMD python3 generate_sm100_reference.py --output /output/sm100_reference.pkl && \
    echo "" && \
    echo "========================================" && \
    echo "Creating archive and checksums..." && \
    echo "========================================" && \
    cd /output && \
    tar -czf sm100_validation_results.tar.gz sm100_reference.pkl sm100_reference.json && \
    sha256sum sm100_reference.pkl sm100_reference.json sm100_validation_results.tar.gz > checksums.txt && \
    echo "" && \
    echo "========================================" && \
    echo "âœ… GB200 Validation Complete!" && \
    echo "========================================" && \
    echo "" && \
    echo "Output files:" && \
    ls -lh /output/ && \
    echo "" && \
    echo "SHA256 Checksums:" && \
    cat /output/checksums.txt && \
    echo "" && \
    echo "Next steps:" && \
    echo "1. Transfer sm100_validation_results.tar.gz to SM120 machine" && \
    echo "2. Transfer checksums.txt for verification" && \
    echo "3. Run compare_sm100_sm120.py on SM120"
